name: 🔁 SCRUM PROYECT

on:
  #issues:
  #  types: [opened]
  workflow_call:
    secrets:
      TEAM_PROJECT_URL:
        description: "URL del tablero de Github del equipo"
        required: true
      ADD_TO_PROJECT_PAT:
        description: "Token de generación"
        required: true

jobs:
  addIssueToProject:
    name: 📝 Adding Issue to Project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/add-to-project@v0.3.0
        with:
          project-url: ${{ secrets.TEAM_PROJECT_URL }}
          # ADD_TO_PROJECT_PAT -> Token de generación.
          # https://docs.github.com/en/enterprise-server@3.6/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          labeled: impedimento, bloqueo
          label-operator: NOT

  createMilestone:
    name: 🗄 Creating User Story
    if: contains( github.event.issue.labels*.name, 'milestone') || contains( github.event.issue.labels*.name, 'US') || contains( github.event.issue.title, '[US]')
    runs-on: ubuntu-latest
    steps:
      - name: Milestone Actions
        id: createmilestone
        uses: kyoyadmoon/milestone-actions@v1.0.0
        with:
          title: "${{ github.event.issue.title }}"
          description: "${{ github.event.issue.body }}"
          # due_on: # An optional timestamp for due date of the milestone
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: echo Milestone number
        run: echo ${{ steps.createmilestone.outputs.number }}

      - name: echo Milestone id
        run: echo ${{ steps.createmilestone.outputs.id }}

      - name: echo Milestone html_url
        run: echo ${{ steps.createmilestone.outputs.html_url }}

  addMilestoneToIssueCreated:
    # Asignar issue de milestone al milestone creado
    name: ✔ Add issue to UserStory
    if: contains(github.event.issue.labels.*.name, 'milestone')
    needs: createMilestone
    runs-on: ubuntu-latest
    steps:
      - uses: guguducken/milestone-add-action@v0.0.1
        with:
          action-token: ${{ secrets.ADD_TO_PROJECT_PAT}}
          co-milestones: >
            {
              "${{ github.event.issue.title }}":"${{ github.event.issue.title }}"
            }

# Crear las tareas https://github.com/marketplace/actions/issue-creator
